{
  "kind": "build_request",
  "title": "Admin pages: stabilize backend actor for all GET queries and standardize React Query caching + unmount cleanup",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Update all admin-page GET data-fetching React Query hooks to use the stable-actor pattern (stabilize the actor reference via `useState` + `useEffect` and only run queries once the stable actor exists), to prevent duplicate API calls caused by actor reference changes.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Implement stable actor pattern with proper cache configuration and cleanup for all admin pages' GET API calls. This is a front end only change",
          "Use `useState` + `useEffect` to stabilize actor reference",
          "Enable query only when stable actor is available"
        ]
      },
      "acceptanceCriteria": [
        "All admin GET hooks derive `rawActor` and `actorFetching` from `useActor()` and then create a `stableActor` state set once when `rawActor` becomes available.",
        "Each admin GET hook’s `queryFn` uses `stableActor` (not `rawActor`) for backend calls and throws a clear error when `stableActor` is not available.",
        "Each admin GET hook sets `enabled: Boolean(stableActor) && !actorFetching` so the query cannot fire before the actor is stable.",
        "No admin GET hook triggers multiple backend calls solely due to actor reference changes (verified by observing network/agent calls when navigating to admin pages)."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Apply the standardized React Query cache configuration to every admin-page GET query (including products, categories, on-sale items, store details, export/statistics, and user management listings).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Standard Configuration for All Admin GET Queries: staleTime: 5 * 60 * 1000 ... gcTime: 30 * 60 * 1000 ... refetchOnMount: false ... refetchOnWindowFocus: false ... retry: 1 ... enabled: Boolean(stableActor) && !actorFetching"
        ]
      },
      "acceptanceCriteria": [
        "Every admin GET `useQuery` sets: `staleTime: 5 * 60 * 1000`, `gcTime: 30 * 60 * 1000`, `refetchOnMount: false`, `refetchOnWindowFocus: false`, and `retry: 1`.",
        "Every admin GET `useQuery` uses `enabled: Boolean(stableActor) && !actorFetching` (with the stable actor from REQ-1).",
        "Query keys remain consistent with existing patterns already in the codebase (e.g., existing `['products', ...]`, `['categories']`, etc.), so other parts of the app that invalidate/refetch still work.",
        "Existing behavior, loading states, and error handling remain intact aside from reducing duplicate calls."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Implement stable-actor + standardized query configuration specifically for the admin Products page GET queries (ensuring all product-related GET hooks used by the Products admin UI follow the same pattern and config).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Admin Products Page: `useGetProductsPage()` - Already implemented as example\n- All product-related query hooks in products page"
        ]
      },
      "acceptanceCriteria": [
        "`useGetProductsPage(...)` continues to work and uses the stable-actor pattern and the standardized cache configuration.",
        "Any additional product-related GET hooks used by the admin products experience (e.g., single-product fetch used within admin flows, if applicable) also use the stable-actor pattern and standardized cache configuration.",
        "No regressions in the ProductsPage UI: searching, filtering, pagination, and modals still function as before."
      ]
    },
    {
      "id": "REQ-4",
      "text": "Implement stable-actor + standardized query configuration for the admin Categories page GET queries (including `useGetAllCategories()` and any other category GET hooks used by the Categories admin UI).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Admin Categories Page: `useGetCategoriesPage()` - Implement stable actor pattern\n- Any category data fetching hooks"
        ]
      },
      "acceptanceCriteria": [
        "`useGetAllCategories()` uses a stable actor (via local `stableActor` state) and the standardized cache configuration.",
        "Any other category GET query hooks used on admin categories screens (e.g., `useGetCategoryById(...)` if used) use the same stable-actor pattern + standardized cache configuration.",
        "Spanish error messages used in category GET hooks remain Spanish (e.g., existing messages like “Error al cargar las categorías”)."
      ]
    },
    {
      "id": "REQ-5",
      "text": "Implement stable-actor + standardized query configuration for the admin On-Sale Products page GET queries (sale items pagination/listing and any product-search GET hooks used for sale item creation/editing).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Admin On-Sale Products Page: `useGetOnSaleProductsPage()` - Implement stable actor pattern\n- Product search hooks for sale items"
        ]
      },
      "acceptanceCriteria": [
        "The sale-items listing GET hook(s) (e.g., the paginated sale items query used by `OnSaleProductsPage`) use the stable-actor pattern and the standardized cache configuration.",
        "Any product-search GET hook used for sale workflows (e.g., searching products to attach to a sale item) uses the stable-actor pattern and the standardized cache configuration.",
        "Search, filters, and pagination on `OnSaleProductsPage` work unchanged, with reduced duplicate fetches."
      ]
    },
    {
      "id": "REQ-6",
      "text": "Implement stable-actor + standardized query configuration for the admin Store Details page GET queries (store details fetch for each store).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Admin Store Details Page: `useGetStoreDetails()` - Implement stable actor pattern\n- Store data fetching hooks"
        ]
      },
      "acceptanceCriteria": [
        "`useGetStoreDetails(storeId)` uses the stable-actor pattern and the standardized cache configuration.",
        "Both store detail queries in `StoreDetailsPage` continue to load reliably and only run once per mount when the actor becomes available.",
        "Existing Spanish error handling/toasts in the Store Details flow remain Spanish."
      ]
    },
    {
      "id": "REQ-7",
      "text": "Implement stable-actor + standardized query configuration for the admin Export page GET queries (export statistics and any other export-related GET queries).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Admin Export Page: `useGetExportData()` - Implement stable actor pattern\n- Statistics and data counting hooks"
        ]
      },
      "acceptanceCriteria": [
        "The export statistics GET query hook(s) (e.g., `useExportStatistics()`) use the stable-actor pattern and the standardized cache configuration.",
        "Any export data GET query hook(s) that fetch backend data for export previewing/statistics also use the stable-actor pattern + standardized cache configuration.",
        "The Export page renders statistics and export actions as before, without duplicate GET calls on mount due to actor changes."
      ]
    },
    {
      "id": "REQ-8",
      "text": "Implement stable-actor + standardized query configuration for the admin User Management page GET queries (e.g., listing users/roles).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Admin User Management Page: `useGetAllUserRoles()` - Implement stable actor pattern\n- User data fetching hooks"
        ]
      },
      "acceptanceCriteria": [
        "The user listing/roles GET query hook(s) used by `UserManagementPage` use the stable-actor pattern and the standardized cache configuration.",
        "The User Management page still enforces admin access as before and maintains existing Spanish messages and labels.",
        "No duplicate GET calls occur on initial load due to actor reference changes."
      ]
    },
    {
      "id": "REQ-9",
      "text": "Add React Query cache cleanup on unmount for each admin page component by removing queries using the specified query-key prefixes (exact: false), so returning to the page results in a fresh load.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Query Cache Clearance on Page Unmount: Clear React Query cache when component unmounts",
          "Products Page: removeQueries({ queryKey: ['products'], exact: false })",
          "Categories Page: removeQueries({ queryKey: ['categories'], exact: false })",
          "On-Sale Products Page: removeQueries({ queryKey: ['sale-items'], exact: false }); removeQueries({ queryKey: ['products', 'search'], exact: false })",
          "Store Details Page: removeQueries({ queryKey: ['store-details'], exact: false })",
          "Export Page: removeQueries({ queryKey: ['export-data'], exact: false })",
          "User Management Page: removeQueries({ queryKey: ['user-roles'], exact: false })"
        ]
      },
      "acceptanceCriteria": [
        "`ProductsPage` removes cached queries on unmount with `queryClient.removeQueries({ queryKey: ['products'], exact: false })`.",
        "`CategoriesPage` removes cached queries on unmount with `queryClient.removeQueries({ queryKey: ['categories'], exact: false })`.",
        "`OnSaleProductsPage` removes cached queries on unmount with `queryClient.removeQueries({ queryKey: ['sale-items'], exact: false })` and `queryClient.removeQueries({ queryKey: ['products', 'search'], exact: false })`.",
        "`StoreDetailsPage` removes cached queries on unmount with `queryClient.removeQueries({ queryKey: ['store-details'], exact: false })`.",
        "`ExportPage` removes cached queries on unmount with `queryClient.removeQueries({ queryKey: ['export-data'], exact: false })`.",
        "`UserManagementPage` removes cached queries on unmount with `queryClient.removeQueries({ queryKey: ['user-roles'], exact: false })`.",
        "After navigating away from an admin page and returning, the page performs a new GET fetch rather than using stale cached data from the prior visit."
      ]
    },
    {
      "id": "REQ-10",
      "text": "Preserve existing Spanish UI and error messages while implementing the stable-actor pattern, standardized React Query config, and unmount cache cleanup (do not translate or replace Spanish strings already present in the UI/toasts).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-5"
        ],
        "quotes": [
          "Maintain Spanish error messages",
          "Maintain Spanish interface and error messages"
        ]
      },
      "acceptanceCriteria": [
        "All existing Spanish UI labels, placeholders, and toasts remain Spanish (no unintended text changes).",
        "Any newly introduced internal errors (e.g., 'Actor not available') remain developer-facing only and do not replace existing Spanish user-facing errors.",
        "Existing error-handling utilities (e.g., toast reporting) continue to be used as before."
      ]
    }
  ],
  "constraints": [
    "Frontend-only change (no backend/Motoko changes).",
    "Do not edit any files under the immutable frontend paths listed in SYSTEM_CONTEXT (compose existing components/hooks instead).",
    "Do not remove, modify, or overwrite the `:root` CSS custom properties block in `frontend/src/index.css`; if any CSS changes are necessary, append them only below the existing block without changing its names/values/structure."
  ],
  "nonGoals": [
    "Do not redesign admin UI pages or change their layouts.",
    "Do not change React Query behavior for non-admin (public) pages.",
    "Do not add new authentication methods; continue using existing Internet Identity flow.",
    "Do not change backend APIs, canister interfaces, or data schemas."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}