{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Full /contacto page with stable actor fetching, robust states, and per-store maps",
  "requirements": [
    {
      "id": "REQ-1",
      "summary": "Replace ContactoPage with a full /contacto view rendered within PublicLayout’s 1200px container and a responsive two-store layout with clear separation.",
      "acceptanceCriteria": [
        "Navigating to `/contacto` renders inside the existing `PublicLayout` (no duplicate header/footer).",
        "The page content remains constrained to 1200px max width (consistent with `PublicLayout`).",
        "On `md` and up, the two store sections render as two equal-width columns; on mobile they stack vertically.",
        "Each store is visually separated (e.g., card borders/spacing/divider) and the layout remains readable at common breakpoints."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/public/ContactoPage.tsx",
          "operation": "modify",
          "description": "Replace the static content with a fully featured /contacto layout that assumes it is rendered inside PublicLayout’s existing max-width container; implement a responsive 1-col (mobile) / 2-col (md+) grid and visually separated store sections (e.g., card-like containers with borders/spacing). Use existing shadcn-ui primitives already in the project (e.g., Button) to keep styling consistent; verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-2",
      "summary": "Fetch both store details with a stabilized actor reference and a single cached React Query call to getBothStoreDetails().",
      "acceptanceCriteria": [
        "The contact page performs at most one `getBothStoreDetails()` call per mount when the actor becomes available (no repeated calls due to actor reference churn).",
        "The React Query fetch is disabled until the stabilized actor is available.",
        "Query caching uses a 30-minute stale time and does not refetch on window focus."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useBothStoreDetails.ts",
          "operation": "modify",
          "description": "Align the existing stable actor hook with the requirement: keep the useState+useEffect stable actor pattern; ensure React Query uses queryKey ['both-store-details'], enabled only when the stable actor exists, staleTime set to 30 minutes, and refetchOnWindowFocus set to false."
        },
        {
          "path": "frontend/src/pages/public/ContactoPage.tsx",
          "operation": "modify",
          "description": "Use the existing useBothStoreDetails hook (stable actor pattern) to fetch store data via the single backend call getBothStoreDetails(), and render UI based on the query result without triggering additional fetches."
        }
      ]
    },
    {
      "id": "REQ-3",
      "summary": "Add an explicit isInitialLoading controller that shows a first-paint loading spinner matching the CategoryPage pattern.",
      "acceptanceCriteria": [
        "On navigation to `/contacto`, the loading UI appears immediately (before data is available).",
        "The spinner uses the same visual styling pattern as `frontend/src/pages/public/CategoryPage.tsx` (centered layout, `Loader2` with `animate-spin` and `text-primary`).",
        "`isInitialLoading` is set to `false` only after the query resolves successfully or errors."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/public/ContactoPage.tsx",
          "operation": "modify",
          "description": "Introduce local state `isInitialLoading` defaulting to true; render an immediate full-page centered loading state using the same Loader2/animate-spin/text-primary pattern as CategoryPage with the exact copy \"Cargando información de contacto...\"; set isInitialLoading to false only when the store-details query settles (success or error)."
        }
      ]
    },
    {
      "id": "REQ-4",
      "summary": "Implement robust error/empty/partial-data flows and only render active stores.",
      "acceptanceCriteria": [
        "If the query errors, the page shows the specified error text and a retry button that triggers a refetch.",
        "If the query succeeds but returns no store details, the page shows a dedicated empty state rather than blank space.",
        "If exactly one active store is available, that store renders and the UI indicates the other store is unavailable/missing.",
        "Inactive stores (`isActive === false`) are not rendered anywhere on the page."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/public/ContactoPage.tsx",
          "operation": "modify",
          "description": "After initial loading, add: (1) error state \"Error al cargar la información de contacto\" with a retry button using the same UX pattern as CategoryPage (centered, outline Button labeled \"Reintentar\" calling query refetch); (2) empty state message when no store details returned; (3) partial-data handling where only one active store renders and the missing store shows a clear message; (4) ensure cards are rendered only for stores where isActive is true. Use the existing shadcn-ui Button styling already used elsewhere; verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-5",
      "summary": "Render the exact Spanish page header copy and ensure Spanish interface labels throughout the /contacto page.",
      "acceptanceCriteria": [
        "The contact page header matches the specified title and subtitle strings exactly.",
        "All user-visible labels on this page use the specified Spanish copy (including store labels for the two columns/sections)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/public/ContactoPage.tsx",
          "operation": "modify",
          "description": "Implement the header section with the exact title \"Contacto - Variety Discount Store\" and subtitle \"Visítanos en nuestras tiendas o contáctanos directamente\"; ensure all labels on this page are Spanish, including section titles and store section labels \"Tienda 1\" and \"Tienda 2\"."
        }
      ]
    },
    {
      "id": "REQ-6",
      "summary": "Render per-store contact info cards with icons and conditional links (directions, tel, WhatsApp, email, and social links).",
      "acceptanceCriteria": [
        "Each rendered store card shows the store name and all available contact fields.",
        "Address is clickable for directions when coordinates are valid; otherwise it is rendered as non-clickable text.",
        "Phone links use `tel:` and WhatsApp uses a `wa.me`-style link; both display formatted numbers in the UI.",
        "Email is a `mailto:` link.",
        "Facebook/Instagram/Website links only render if their corresponding field has a value."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/public/ContactoPage.tsx",
          "operation": "modify",
          "description": "Within each active store card, render: prominent store name; address row with location icon and a directions link only when coordinates are valid; phone as tel: link; WhatsApp as wa.me link; email as mailto: link; and conditional social links (Facebook/Instagram/Website) with recognizable icons and target=_blank/rel=noopener noreferrer when applicable."
        },
        {
          "path": "frontend/src/utils/phoneFormat.ts",
          "operation": "modify",
          "description": "Add a utility that returns a wa.me-safe number (digits-only, no '+', spaces, parentheses, or dashes) to ensure WhatsApp links follow the required wa.me style while keeping existing formatting helpers intact."
        },
        {
          "path": "frontend/src/utils/googleMaps.ts",
          "operation": "modify",
          "description": "Extend the maps utility to also support parsing/validating the coordinates JSON into a typed {lat,lng} result (or null) so the contact page can decide when an address should be clickable and when map UI should be shown."
        }
      ]
    },
    {
      "id": "REQ-7",
      "summary": "Display per-store opening hours titled \"Horario de Apertura\" with English-to-Spanish day translation and clean day/hours stacking layout.",
      "acceptanceCriteria": [
        "Store hours are rendered as a per-day list where day name and hours are visually separated (day on its own line, hours below).",
        "English day labels from the backend are translated to the correct Spanish day labels.",
        "If a store has no hours data, the hours section is omitted (or a clear closed/unknown message is shown consistently)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/public/ContactoPage.tsx",
          "operation": "modify",
          "description": "Add a \"Horario de Apertura\" section per active store that parses the backend storeHours tuple array and renders each item with a bold Spanish day label (using the existing translateDayToSpanish helper) and the hours on a separate line below; omit the section (or show a consistent unknown/closed message) when there is no hours data."
        }
      ]
    },
    {
      "id": "REQ-8",
      "summary": "Render a per-store Google Maps embed and an \"Obtener Direcciones\" button driven by validated coordinates with graceful fallback.",
      "acceptanceCriteria": [
        "Valid coordinates produce a visible embedded map per store with a fixed ~300px height and responsive width.",
        "The map iframe is lazy-loaded (e.g., `loading=\"lazy\"`) and remains usable (zoom/pan) within the iframe constraints.",
        "The \"Obtener Direcciones\" button opens the exact directions URL format with the store’s coordinates.",
        "Invalid/missing coordinates do not crash the page; instead the map section renders a fallback message and does not show a broken iframe/button."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/public/ContactoPage.tsx",
          "operation": "modify",
          "description": "Implement a map section per active store: parse the coordinates JSON; when valid, render a responsive iframe embed (fixed ~300px height, rounded corners) with loading=\"lazy\" and an interactive Google Maps view centered on the coordinates, plus a primary \"Obtener Direcciones\" button (with a navigation icon) opening `https://www.google.com/maps/dir/?api=1&destination=${latitude},${longitude}` in a new tab; when invalid, hide iframe/button and show a clear fallback message. Use the existing shadcn-ui Button component for the primary CTA; verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/utils/googleMaps.ts",
          "operation": "modify",
          "description": "Add/extend helpers to (a) parse coordinates JSON into {lat,lng} with validation and (b) generate the exact directions URL format used by the \"Obtener Direcciones\" button, returning null when invalid."
        }
      ]
    },
    {
      "id": "REQ-9",
      "summary": "Ensure any styling changes preserve the existing :root CSS variables block in frontend/src/index.css and only append styles below it if needed.",
      "acceptanceCriteria": [
        "The `:root` block in `frontend/src/index.css` remains byte-for-byte unchanged.",
        "Any added CSS appears after the existing variables block and does not alter the existing theme tokens."
      ],
      "file_operations": [
        {
          "path": "frontend/src/index.css",
          "operation": "modify",
          "description": "If any global styling is required for the new /contacto UI, append it only after the existing `:root` variables block without altering the block’s content, names, values, or structure; otherwise keep changes limited to an appended comment/reminder below the variables block to document the constraint."
        }
      ]
    }
  ]
}